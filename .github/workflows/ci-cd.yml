name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2048m'

jobs:
  test:
    name: Run Tests and Generate Coverage
    runs-on: ubuntu-latest
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: dynamodb,s3,secretsmanager
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost:4566/_localstack/health; do sleep 2; done'
          echo "‚úÖ LocalStack is ready"
          # Give LocalStack a moment to fully initialize DynamoDB service
          sleep 3

      - name: Verify LocalStack DynamoDB
        run: |
          echo "Verifying LocalStack DynamoDB service..."
          # Check if DynamoDB is available
          curl -f http://localhost:4566/_localstack/health | grep -q dynamodb && echo "‚úÖ DynamoDB service is available" || echo "‚ö†Ô∏è DynamoDB service check failed"
          # Note: Tables will be auto-created by DynamoDBTableManager when Spring Boot starts
          # The @PostConstruct method in DynamoDBTableManager will create all tables automatically

      - name: Verify Redis (Optional)
        run: |
          echo "Verifying Redis service (optional for tests)..."
          # Install redis-cli if not available (Ubuntu)
          sudo apt-get update -qq && sudo apt-get install -y redis-tools || echo "‚ö†Ô∏è redis-cli installation skipped"
          # Check if Redis is available (optional - DistributedLock handles null gracefully)
          redis-cli -h localhost -p 6379 ping && echo "‚úÖ Redis is available" || echo "‚ö†Ô∏è Redis is not available (tests will use in-memory fallback - this is OK)"

      - name: Initialize DynamoDB Tables
        env:
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          DYNAMODB_ENDPOINT: http://localhost:4566
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
          JWT_SECRET: test-jwt-secret-key-for-testing-only-must-be-at-least-64-characters-long-for-hs512-algorithm
          APP_CONFIG_ENABLED: false
          AWS_SECRETS_MANAGER_ENABLED: false
          AWS_CLOUDWATCH_ENABLED: false
        run: |
          echo "üîß Initializing DynamoDB tables using standalone TableInitializerMain..."
          # CRITICAL: Use standalone Java main class to initialize tables BEFORE any Spring contexts are created
          # This ensures tables exist in LocalStack before any tests run
          
          # Compile test classes first
          mvn test-compile -DskipTests
          
          # Run TableInitializerMain using Maven exec plugin
          # This creates tables directly in LocalStack without needing Spring context
          mvn exec:java \
            -Dexec.mainClass="com.budgetbuddy.util.TableInitializerMain" \
            -Dexec.classpathScope="test" \
            -Dexec.args="" || {
            echo "‚ùå Table initialization failed!"
            echo "Attempting fallback: Running InfrastructureIntegrationTest..."
            mvn test -Dtest=InfrastructureIntegrationTest#testDynamoDBClient_IsConfigured -DfailIfNoTests=false || {
              echo "‚ö†Ô∏è Fallback table initialization also failed"
              exit 1
            }
          }
          
          # Wait for tables to be fully ready (increased wait time for GSI creation)
          echo "Waiting for tables to be fully ready (including GSIs)..."
          sleep 10  # Increased from 5 to 10 seconds to allow GSIs to be created
          
          # Verify critical tables exist using AWS CLI (if available)
          echo "Verifying critical tables exist with proper schemas..."
          if command -v aws &> /dev/null; then
            # Check for Users table (most critical) and verify it has EmailIndex GSI
            if aws dynamodb describe-table --table-name TestBudgetBuddy-Users --endpoint-url http://localhost:4566 --region us-east-1 &> /dev/null; then
              echo "‚úÖ Users table exists"
              # Verify EmailIndex GSI exists
              if aws dynamodb describe-table --table-name TestBudgetBuddy-Users --endpoint-url http://localhost:4566 --region us-east-1 2>&1 | grep -q "EmailIndex"; then
                echo "‚úÖ Users table has EmailIndex GSI"
              else
                echo "‚ö†Ô∏è Users table missing EmailIndex GSI - this may cause test failures"
              fi
            else
              echo "‚ö†Ô∏è Users table not found - this may cause test failures"
            fi
            
            # Check Accounts table
            if aws dynamodb describe-table --table-name TestBudgetBuddy-Accounts --endpoint-url http://localhost:4566 --region us-east-1 &> /dev/null; then
              echo "‚úÖ Accounts table exists"
            else
              echo "‚ö†Ô∏è Accounts table not found"
            fi
            
            # Check Transactions table
            if aws dynamodb describe-table --table-name TestBudgetBuddy-Transactions --endpoint-url http://localhost:4566 --region us-east-1 &> /dev/null; then
              echo "‚úÖ Transactions table exists"
            else
              echo "‚ö†Ô∏è Transactions table not found"
            fi
          else
            echo "‚ö†Ô∏è AWS CLI not available, skipping table verification"
            echo "‚ö†Ô∏è Note: Tables should be created by TableInitializerMain"
          fi
          
          echo "‚úÖ DynamoDB tables initialization complete"

      - name: Run unit tests
        env:
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          DYNAMODB_ENDPOINT: http://localhost:4566
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
          JWT_SECRET: test-jwt-secret-key-for-testing-only-must-be-at-least-64-characters-long-for-hs512-algorithm
          APP_CONFIG_ENABLED: false
          AWS_SECRETS_MANAGER_ENABLED: false
          AWS_CLOUDWATCH_ENABLED: false
        run: |
          # Exclude InfrastructureIntegrationTest as it was already run for table initialization
          mvn test -DfailIfNoTests=false -Dtest='!InfrastructureIntegrationTest'

      - name: Run integration tests
        env:
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          DYNAMODB_ENDPOINT: http://localhost:4566
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
          JWT_SECRET: test-jwt-secret-key-for-testing-only-must-be-at-least-64-characters-long-for-hs512-algorithm
          APP_CONFIG_ENABLED: false
          AWS_SECRETS_MANAGER_ENABLED: false
          AWS_CLOUDWATCH_ENABLED: false
        run: mvn verify -DfailIfNoTests=false

      - name: Generate coverage report
        run: mvn jacoco:report

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./target/site/jacoco/jacoco.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/

      - name: Check coverage threshold
        run: |
          # Extract coverage percentage from JaCoCo report
          COVERAGE=$(grep -oP 'tfoot.*?(\d+\.\d+)%' target/site/jacoco/index.html | grep -oP '\d+\.\d+' | head -1 || echo "0")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "Coverage $COVERAGE% is below 95% threshold"
            exit 1
          fi

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build application
        run: mvn clean package -DskipTests

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging-api.budgetbuddy.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to ECS
        run: |
          echo "Deploying to staging ECS..."
          # Add your ECS deployment commands here
          # aws ecs update-service --cluster staging-cluster --service budgetbuddy-backend --force-new-deployment

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://api.budgetbuddy.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to ECS
        run: |
          echo "Deploying to production ECS..."
          # Add your ECS deployment commands here
          # aws ecs update-service --cluster production-cluster --service budgetbuddy-backend --force-new-deployment

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'BudgetBuddy-Backend'
          path: '.'
          format: 'HTML'

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: reports/

