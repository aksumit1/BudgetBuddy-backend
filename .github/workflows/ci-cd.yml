name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2048m'

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Run unit tests only (no integration tests, no LocalStack)
        env:
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          DYNAMODB_ENDPOINT: http://localhost:4566
          JWT_SECRET: test-jwt-secret-key-for-testing-only-must-be-at-least-64-characters-long-for-hs512-algorithm
          APP_CONFIG_ENABLED: false
          AWS_SECRETS_MANAGER_ENABLED: false
          AWS_CLOUDWATCH_ENABLED: false
          SKIP_INTEGRATION_TESTS: true
        run: |
          # Run only unit tests (exclude integration tests that require LocalStack)
          mvn test -DfailIfNoTests=false -Dtest='!*IntegrationTest,!*E2ETest'

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build application (skip tests)
        run: mvn clean package -DskipTests

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
