name: GitHub Actions Security

# Scans GitHub Actions workflows for security best practices
# Free tool to ensure workflows follow security guidelines

on:
  push:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  actionlint:
    name: GitHub Actions Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          fail_level: error
          filter_mode: nofilter

      - name: Check for security issues in workflows
        run: |
          echo "Checking GitHub Actions workflows for security best practices..."
          
          # Check for hardcoded secrets (more specific patterns to avoid false positives)
          # Look for actual secret values, not references to secrets
          FOUND_SECRETS=false
          
          # Pattern 1: Hardcoded passwords (password: "value" or password=value)
          if grep -rE "(password|passwd|pwd)\s*[:=]\s*['\"][^'\"]{8,}" .github/workflows/ --include="*.yml" --include="*.yaml" | grep -v "secrets\." | grep -v "#" | grep -v "secret-scan" | grep -v "secret-scanning" | grep -v "SECRETS=" | grep -v "secret-id" | grep -v "secret-name" | grep -v "secret_arn" | grep -v "secret:" | grep -v "secrets:"; then
            echo "⚠️ Potential hardcoded password found in workflows"
            FOUND_SECRETS=true
          fi
          
          # Pattern 2: Hardcoded tokens (token: "value" or token=value, but not GITHUB_TOKEN or secrets.token)
          if grep -rE "(token|api_key|apikey|access_key)\s*[:=]\s*['\"][a-zA-Z0-9]{20,}" .github/workflows/ --include="*.yml" --include="*.yaml" -i | grep -v "secrets\." | grep -v "GITHUB_TOKEN" | grep -v "#" | grep -v "secret-scan" | grep -v "secret-scanning" | grep -v "SNYK_TOKEN" | grep -v "token:"; then
            echo "⚠️ Potential hardcoded token/API key found in workflows"
            FOUND_SECRETS=true
          fi
          
          # Pattern 3: AWS keys (AKIA pattern)
          if grep -rE "AKIA[0-9A-Z]{16}" .github/workflows/ --include="*.yml" --include="*.yaml" | grep -v "#"; then
            echo "⚠️ Potential AWS access key found in workflows"
            FOUND_SECRETS=true
          fi
          
          # Pattern 4: Private keys (BEGIN PRIVATE KEY)
          if grep -rE "BEGIN.*PRIVATE KEY" .github/workflows/ --include="*.yml" --include="*.yaml" | grep -v "#"; then
            echo "⚠️ Potential private key found in workflows"
            FOUND_SECRETS=true
          fi
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "❌ Security check failed: Potential hardcoded secrets detected"
            exit 1
          fi
          
          # Check for use of actions/checkout with persist-credentials
          if grep -r "persist-credentials: true" .github/workflows/ --include="*.yml" --include="*.yaml"; then
            echo "⚠️ Found persist-credentials: true - ensure this is intentional"
          fi
          
          # Check for use of GITHUB_TOKEN with write permissions
          if grep -r "permissions:" .github/workflows/ --include="*.yml" --include="*.yaml" -A 5 | grep -i "write"; then
            echo "ℹ️ Workflows with write permissions detected - ensure this is necessary"
          fi
          
          echo "✅ Security checks completed"

