# Plaid Account ID Format

## Overview

Plaid account IDs (`account_id`) are **unique string identifiers** assigned by Plaid to each financial account linked through their API. These IDs are returned directly from Plaid's API and stored as-is in our database.

## Format Characteristics

### 1. **Not Base64 Encoded**
- Plaid account IDs are **not base64 encoded**
- They are plain alphanumeric strings returned directly from the Plaid API
- We store them as-is without any encoding/decoding

### 2. **Not Hashed**
- Plaid account IDs are **not hashes** (not MD5, SHA-1, SHA-256, etc.)
- They are **opaque identifiers** generated by Plaid's proprietary system
- The exact generation algorithm is not publicly documented by Plaid

### 3. **Typical Format**
Based on Plaid's API documentation and examples:
- **Length**: Typically 20-40 characters
- **Characters**: Alphanumeric (letters and numbers)
- **Example**: `"QPO8Jo8vdDHMepg41PBwckXm4KdK1yUdmXOwK"`
- **Case**: Usually mixed case (both uppercase and lowercase letters)

### 4. **Opaque Identifier**
- Plaid account IDs are **opaque identifiers** - they don't contain any meaningful information about the account
- They are designed to be unique and secure
- The exact obfuscation/encoding method is proprietary to Plaid

## Important Notes

### Account ID Stability

#### In Sandbox Environment
✅ **Generally Stable**: Plaid account IDs in sandbox are **designed to remain consistent** across requests, **NOT changing on every request**.

**They remain stable when:**
- Using the same `access_token` for the same account
- Account details remain unchanged
- The same Plaid Item is used

**They CAN change when:**
- ⚠️ **Access token is deleted and regenerated** - This is a common cause of duplicates!
- Account name changes significantly and Plaid cannot reconcile it
- Account details change in ways Plaid cannot match

#### In Production Environment
Same behavior as sandbox - account IDs are stable unless:
- Account is disconnected and reconnected
- Access token is regenerated
- Account details change significantly
- During certain Plaid API updates
- In rare cases during account maintenance

### Why Duplicates Occur

If you're seeing duplicate accounts with different `plaidAccountId` values, it's likely because:

1. **Access Token Regeneration**: The most common cause - if the access token is deleted and regenerated, Plaid assigns new account IDs
2. **Multiple Link Sessions**: If the same bank account is linked multiple times, each link session may get different account IDs
3. **Account Name Changes**: If the account name changes between syncs, Plaid may assign a new ID

### Persistent Account ID
For more stable identification, Plaid provides `persistent_account_id`:
- Remains consistent even if `account_id` changes
- Better for long-term tracking
- Available for depository accounts
- **Recommendation**: Consider using `persistent_account_id` as a secondary deduplication key

## How We Use Plaid Account IDs

### In Our Codebase

1. **Extraction**: We extract the account ID directly from Plaid's `AccountBase` object:
   ```java
   String accountId = accountBase.getAccountId();
   ```

2. **Storage**: We store it directly in our database as `plaidAccountId`:
   ```java
   account.setPlaidAccountId(accountId);
   ```

3. **Deduplication**: We use `plaidAccountId` as the primary key for deduplication:
   ```java
   Optional<AccountTable> existingAccount = accountRepository.findByPlaidAccountId(accountId);
   ```

4. **No Transformation**: We do **not**:
   - Base64 encode/decode
   - Hash the value
   - Apply any obfuscation
   - Transform the format in any way

### Example in Database

When stored in DynamoDB, a Plaid account ID looks like:
```
plaidAccountId: "QPO8Jo8vdDHMepg41PBwckXm4KdK1yUdmXOwK"
```

This is stored as a plain string attribute.

## Verification

To verify the format of Plaid account IDs in your database, you can:

1. **Check the script output**: Run `./scripts/analyze-duplicates-simple.sh` and look at the `plaidAccountId` field
2. **Check logs**: Look for log entries like:
   ```
   Extracted account ID: QPO8Jo8vdDHMepg41PBwckXm4KdK1yUdmXOwK
   ```
3. **Query DynamoDB directly**: The IDs will appear as plain alphanumeric strings

## Summary

- **Format**: Plain alphanumeric string (20-40 characters, mixed case)
- **Encoding**: None - stored as-is from Plaid API
- **Obfuscation**: Proprietary to Plaid (not publicly documented)
- **Stability**: Can change in some circumstances
- **Usage**: Primary deduplication key in our system

