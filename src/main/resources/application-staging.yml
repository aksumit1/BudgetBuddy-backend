# Staging Environment Configuration
# Production-like environment for testing before production deployment

spring:
  profiles:
    active: staging
  
  # Data Source (if using RDS in staging)
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://staging-db.budgetbuddy.com:5432/budgetbuddy}
    username: ${DATABASE_USERNAME:budgetbuddy}
    password: ${DATABASE_PASSWORD:}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # DynamoDB Configuration
  dynamodb:
    endpoint: ${DYNAMODB_ENDPOINT:}
    region: ${AWS_REGION:us-east-1}
    table-prefix: BudgetBuddyStaging
    auto-create-tables: false # Tables should already exist in staging

server:
  port: 8080
  address: 0.0.0.0
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
  error:
    include-message: always
    include-stacktrace: on_param
    include-binding-errors: always

# AWS Configuration
app:
  aws:
    region: ${AWS_REGION:us-east-1}
    dynamodb:
      endpoint: ${DYNAMODB_ENDPOINT:}
      timeout-seconds: 10
      auto-create-tables: false
    s3:
      bucket: budgetbuddy-staging-storage
    secrets-manager:
      enabled: true
      refresh-interval: 3600
    appconfig:
      enabled: true
      application: budgetbuddy-backend
      environment: staging
      config-profile: staging
      refresh-interval: 60
    cloudwatch:
      enabled: true

  # JWT Configuration
  jwt:
    secret: ${JWT_SECRET:}
    secret-name: ${JWT_SECRET_NAME:budgetbuddy/jwt-secret}
    expiration: 900000 # 15 minutes (short-lived for Zero Trust)
    refresh-expiration: 2592000000 # 30 days (longer-lived, encrypted in keychain)

  # MFA Configuration
  mfa:
    totp:
      issuer: BudgetBuddy
    backup-codes:
      count: 10
      length: 8
    otp:
      expiration-seconds: 300 # 5 minutes

  # FIDO2/WebAuthn Configuration
  fido2:
    rp-id: ${FIDO2_RP_ID:staging.budgetbuddy.com}
    rp-name: BudgetBuddy (Staging)
    origin: ${FIDO2_ORIGIN:https://staging.budgetbuddy.com}
    challenge:
      expiration-seconds: 300 # 5 minutes

  # Device Attestation Configuration
  device-attestation:
    enabled: true
    devicecheck-enabled: true # iOS DeviceCheck
    play-integrity-enabled: true # Android Play Integrity
    trust-window-hours: 24

  # Behavioral Analysis Configuration
  behavioral-analysis:
    enabled: true
    activity-history-size: 100
    anomaly-detection-window-seconds: 3600
    high-risk-threshold: 70.0
    medium-risk-threshold: 40.0

  # Plaid Configuration
  plaid:
    client-id: ${PLAID_CLIENT_ID:}
    secret: ${PLAID_SECRET:}
    environment: ${PLAID_ENVIRONMENT:sandbox} # Use sandbox for staging
    webhook-verification-key: ${PLAID_WEBHOOK_VERIFICATION_KEY:}
    redirect-uri: ${PLAID_REDIRECT_URI:https://staging.budgetbuddy.com/plaid/callback}
    webhook-url: ${PLAID_WEBHOOK_URL:https://staging-api.budgetbuddy.com/api/plaid/webhooks}

  # Stripe Configuration
  stripe:
    secret-key: ${STRIPE_SECRET_KEY:sk_test_}

  # Rate Limiting (staging - more lenient than production)
  rate-limit:
    enabled: true
    requests-per-minute: 5000
    requests-per-hour: 250000
    auth-login: 500
    auth-signup: 250
    plaid: 25000
    transactions: 250000
    analytics: 50000
    default: 250000
    ddos:
      max-requests-per-minute: 50000
      max-requests-per-hour: 2500000

  # Security
  security:
    cors:
      allowed-origins: ${CORS_ALLOWED_ORIGINS:https://staging.budgetbuddy.com,https://staging-app.budgetbuddy.com}
      allowed-methods: GET,POST,PUT,DELETE,OPTIONS
      allowed-headers: "*"
      allow-credentials: true
    encryption:
      algorithm: AES-256-GCM
      key: ${ENCRYPTION_KEY:}
    tls:
      min-version: TLSv1.2
      enabled-protocols: TLSv1.2,TLSv1.3
    certificate-pinning:
      enabled: true
      certificates: ${CERTIFICATE_PINNED_HASHES:}

  # Compliance
  compliance:
    audit-log:
      enabled: true
      retention-days: 2555 # 7 years for FINRA
    pci-dss:
      enabled: true
    soc2:
      enabled: true
    finra:
      enabled: true
    hipaa:
      enabled: true
    gdpr:
      enabled: true
    dma:
      enabled: true

  # Performance
  performance:
    cache:
      enabled: true
      default-ttl: 1800
      max-size: 10000
      warming:
        enabled: true

# Logging
logging:
  level:
    root: INFO
    com.budgetbuddy: DEBUG
    org.springframework.security: WARN
    org.springframework.web: INFO
    software.amazon.awssdk: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Management
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  health:
    redis:
      timeout: 2s

# Spring Data
spring:
  data:
    redis:
      connect-timeout: 1000ms
      lettuce:
        shutdown-timeout: 100ms
        pool:
          max-wait: 1000ms
          max-active: 16
          min-idle: 2
          test-on-borrow: true
          test-while-idle: true
    web:
      pageable:
        one-indexed-parameters: true
    redis:
      repositories:
        enabled: false

