spring:
  application:
    name: budgetbuddy-backend-test
  
  # Enable bean definition overriding for tests
  main:
    allow-bean-definition-overriding: true
  
  # Test Database Configuration
  dynamodb:
    endpoint: ${DYNAMODB_ENDPOINT:http://localhost:4566} # LocalStack endpoint for testing (can be overridden via env var)
    region: us-east-1

# Server Configuration for Tests
# Use port 0 to get a random available port, or specify a different port
# This prevents conflicts when the main application is running on 8080
server:
  port: 0  # Random port - Spring Boot will find an available port automatically
  
  # Redis Configuration (Optional for tests - will use in-memory if not available)
  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:localhost}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      timeout: 2000ms
      # In tests, Redis is optional - tests will work without it
      # If Redis is not available, some features may be disabled but tests should still pass

# Test Application Configuration
app:
  name: BudgetBuddy Backend Test
  version: 1.0.0-test
  
  aws:
    region: us-east-1
    dynamodb:
      table-prefix: TestBudgetBuddy
      endpoint: ${DYNAMODB_ENDPOINT:http://localhost:4566} # Can be overridden via env var for different LocalStack instances
      auto-create-tables: true # Enable table auto-creation in tests - ensures tables exist for proper testing
    s3:
      bucket-name: test-budgetbuddy-storage
    cloudwatch:
      enabled: false # Disable CloudWatch in tests
    appconfig:
      enabled: false # Disable AppConfig in tests to avoid AWS region requirement
  
  jwt:
    # JWT secret must be at least 64 characters (512 bits) for HS512 algorithm
    secret: test-jwt-secret-key-for-testing-only-must-be-at-least-64-characters-long-for-hs512-algorithm
    expiration: 3600000 # 1 hour for tests
    refresh-expiration: 86400000 # 1 day for tests
  
  plaid:
    client-id: test-client-id
    secret: test-secret
    environment: sandbox
  
  # MFA Configuration for Tests
  mfa:
    # Return OTP in response for testing (LocalStack doesn't send real SMS/email)
    return-otp-in-response: true
  
  rate-limit:
    enabled: false # Disable rate limiting in tests to avoid interference with test execution
    requests-per-minute: 1000000000 # 1 billion per minute (extremely high for CI/GitHub)
    requests-per-hour: 10000000000 # 10 billion per hour (extremely high for CI/GitHub)
    # Per-endpoint limits for tests (extremely high to support CI/GitHub test runs and multiple mvn install executions)
    # Increased significantly to handle CI/GitHub test runs and multiple mvn install executions
    auth-login: 100000000 # 100 million per minute
    auth-signup: 100000000 # 100 million per minute
    auth-register: 100000000 # 100 million per minute
    auth-refresh: 100000000 # 100 million per minute
    auth-change-password: 100000000 # 100 million per minute
    auth-forgot-password: 100000000 # 100 million per minute
    auth-reset-password: 100000000 # 100 million per minute
    plaid: 1000000000 # 1 billion per minute (Plaid errors are common in tests, need extremely high limit)
    transactions: 1000000000 # 1 billion per minute
    transaction-actions: 1000000000 # 1 billion per minute
    users: 1000000000 # 1 billion per minute
    analytics: 1000000000 # 1 billion per minute
    default: 1000000000 # 1 billion per minute
    # DDoS protection limits (must be under rate-limit.ddos for DDoSProtectionService to read)
    # Property path: app.rate-limit.ddos.max-requests-per-minute (as used in DDoSProtectionService.java:32)
    ddos:
      max-requests-per-minute: 1000000000 # 1 billion per minute (extremely high for CI/GitHub)
      max-requests-per-hour: 10000000000 # 10 billion per hour (extremely high for CI/GitHub)
      # 404 Error Tracking Configuration
      # Note: Some tests expect blocking at 20 requests, so we use a lower threshold for those tests
      # Other tests can handle higher thresholds
      notfound:
        max-per-minute: 1000000  # Very high limit for tests (1 million per minute) - only NotFoundErrorTrackingIntegrationTest uses lower limit
        max-per-hour: 10000000   # Very high limit for tests (10 million per hour)
  
  # Legacy ddos section (for NotFoundErrorTrackingService which reads from app.ddos.notfound.*)
  # Property path: app.ddos.notfound.max-per-minute (as used in NotFoundErrorTrackingService.java:32)
  # This is separate from rate-limit.ddos because NotFoundErrorTrackingService uses app.ddos.notfound.*
  ddos:
    # 404 Error Tracking Configuration (for NotFoundErrorTrackingService)
    # Note: NotFoundErrorTrackingIntegrationTest specifically tests 404 tracking with threshold of 20
    # For that test, we'll use @TestPropertySource to override with lower limit
    notfound:
      enabled: false  # Disable 404 error tracking in tests (except NotFoundErrorTrackingIntegrationTest which overrides this)
      max-per-minute: 1000000  # Very high limit for tests (1 million per minute) - only NotFoundErrorTrackingIntegrationTest uses lower limit
      max-per-hour: 10000000   # Very high limit for tests (10 million per hour)
  
  security:
    cors:
      allowed-origins: "*" # Allow all in tests
    certificate-pinning:
      enabled: false # Disable in tests
    tls:
      min-version: TLSv1.2
      enabled-protocols: TLSv1.2,TLSv1.3

# Resilience4j Circuit Breaker Configuration for Tests (Very Lenient for Heavy Testing)
resilience4j:
  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 95  # Very high threshold - only open at 95% failure rate
        waitDurationInOpenState: 5s  # Short wait time for faster recovery
        slidingWindowSize: 1000  # Large window to prevent premature opening
        minimumNumberOfCalls: 100  # Need many calls before circuit can open
        permittedNumberOfCallsInHalfOpenState: 50  # Allow many test calls
        automaticTransitionFromOpenToHalfOpenEnabled: true
    instances:
      plaid:
        failureRateThreshold: 95  # Very high threshold - only open at 95% failure rate
        waitDurationInOpenState: 5s  # Short wait time for faster recovery
        slidingWindowSize: 1000  # Large window to prevent premature opening
        minimumNumberOfCalls: 100  # Need many calls before circuit can open
        permittedNumberOfCallsInHalfOpenState: 50  # Allow many test calls
        automaticTransitionFromOpenToHalfOpenEnabled: true
  retry:
    instances:
      plaid:
        maxAttempts: 10  # More retry attempts for heavy testing
        waitDuration: 100ms  # Shorter wait between retries
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 1.5  # Slower backoff for heavy testing

# Logging
logging:
  level:
    root: INFO
    com.budgetbuddy: DEBUG
    org.springframework: WARN
    software.amazon.awssdk: WARN
