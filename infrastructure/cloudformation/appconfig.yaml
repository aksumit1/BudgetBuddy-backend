AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS AppConfig for BudgetBuddy Backend Configuration Management'

Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues: [development, staging, production]

Resources:
  # AppConfig Application
  AppConfigApplication:
    Type: AWS::AppConfig::Application
    Properties:
      Name: budgetbuddy-backend
      Description: BudgetBuddy Backend Application Configuration
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: budgetbuddy-backend

  # AppConfig Environment
  AppConfigEnvironment:
    Type: AWS::AppConfig::Environment
    Properties:
      ApplicationId: !Ref AppConfigApplication
      Name: !Ref Environment
      Description: !Sub '${Environment} environment configuration'
      Monitors:
        - AlarmArn: !GetAtt ConfigurationAlarm.Arn
          AlarmRoleArn: !GetAtt AppConfigAlarmRole.Arn

  # Configuration Profile
  AppConfigConfigurationProfile:
    Type: AWS::AppConfig::ConfigurationProfile
    Properties:
      ApplicationId: !Ref AppConfigApplication
      Name: default
      Description: Default configuration profile
      LocationUri: hosted
      Type: FREEFORM
      Validators:
        - Type: JSON_SCHEMA
          Content: |
            {
              "$schema": "http://json-schema.org/draft-04/schema#",
              "type": "object",
              "properties": {
                "featureFlags": {
                  "type": "object"
                },
                "rateLimits": {
                  "type": "object"
                },
                "cacheSettings": {
                  "type": "object"
                }
              }
            }

  # Hosted Configuration Version
  AppConfigHostedConfigurationVersion:
    Type: AWS::AppConfig::HostedConfigurationVersion
    Properties:
      ApplicationId: !Ref AppConfigApplication
      ConfigurationProfileId: !Ref AppConfigConfigurationProfile
      Content: |
        {
          "featureFlags": {
            "plaid": true,
            "stripe": true,
            "oauth2": false,
            "advancedAnalytics": false,
            "notifications": true
          },
          "rateLimits": {
            "perUser": 100,
            "perIp": 1000,
            "windowSeconds": 60
          },
          "cacheSettings": {
            "defaultTtl": 1800,
            "maxSize": 10000
          }
        }
      ContentType: application/json
      Description: Initial configuration version

  # Deployment Strategy
  AppConfigDeploymentStrategy:
    Type: AWS::AppConfig::DeploymentStrategy
    Properties:
      Name: !Sub '${AWS::StackName}-deployment-strategy'
      Description: Canary deployment strategy with validation
      DeploymentDurationInMinutes: 15
      GrowthFactor: 25.0
      GrowthType: EXPONENTIAL
      FinalBakeTimeInMinutes: 5
      ReplicateTo: NONE

  # Deployment
  AppConfigDeployment:
    Type: AWS::AppConfig::Deployment
    Properties:
      ApplicationId: !Ref AppConfigApplication
      ConfigurationProfileId: !Ref AppConfigConfigurationProfile
      ConfigurationVersion: !Ref AppConfigHostedConfigurationVersion
      DeploymentStrategyId: !Ref AppConfigDeploymentStrategy
      EnvironmentId: !Ref AppConfigEnvironment
      Description: Initial configuration deployment

  # CloudWatch Alarm for Configuration
  ConfigurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-appconfig-alarm'
      AlarmDescription: Alert on configuration deployment issues
      MetricName: DeploymentEvents
      Namespace: AWS/AppConfig
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  # IAM Role for AppConfig Alarms
  AppConfigAlarmRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-appconfig-alarm-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: appconfig.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess

Outputs:
  AppConfigApplicationId:
    Description: AppConfig Application ID
    Value: !Ref AppConfigApplication

  AppConfigEnvironmentId:
    Description: AppConfig Environment ID
    Value: !Ref AppConfigEnvironment

  AppConfigConfigurationProfileId:
    Description: AppConfig Configuration Profile ID
    Value: !Ref AppConfigConfigurationProfile

  AppConfigDeploymentStrategyId:
    Description: AppConfig Deployment Strategy ID
    Value: !Ref AppConfigDeploymentStrategy

