#!/bin/bash
#
# Git pre-push hook for BudgetBuddy Backend
# Runs all tests before allowing push to GitHub
#
# This hook runs:
# 1. mvn test (unit tests)
# 2. mvn install (build + install)
# 3. mvn verify (integration tests)
#
# To skip this hook: git push --no-verify

set -e

echo "üîç BudgetBuddy Backend - Pre-push Test Hook"
echo "=============================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Maven is available
if ! command -v mvn &> /dev/null; then
    echo -e "${RED}‚ùå Maven (mvn) not found. Please install Maven first.${NC}"
    exit 1
fi

# Check if Docker is available (required for LocalStack)
if ! command -v docker &> /dev/null; then
    echo -e "${RED}‚ùå Docker not found. Please install Docker first.${NC}"
    exit 1
fi

# Check if docker-compose is available
if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}‚ùå docker-compose not found. Please install docker-compose first.${NC}"
    exit 1
fi

# Get the project root directory
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

echo "üìÅ Project root: $PROJECT_ROOT"
echo ""

# Check if we're in the backend directory
if [ ! -f "pom.xml" ]; then
    echo -e "${RED}‚ùå pom.xml not found. Are you in the BudgetBuddy-Backend directory?${NC}"
    exit 1
fi

# Check if run-tests-with-localstack.sh exists
if [ ! -f "run-tests-with-localstack.sh" ]; then
    echo -e "${RED}‚ùå run-tests-with-localstack.sh not found!${NC}"
    echo -e "${YELLOW}üí° This script is required to run tests with LocalStack${NC}"
    exit 1
fi

# Make sure the script is executable
chmod +x run-tests-with-localstack.sh

# Ask user if they want to skip (useful for emergency pushes)
echo -e "${YELLOW}‚ö†Ô∏è  This will run: mvn test, mvn install, and mvn verify${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  LocalStack will be started automatically for each command${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  This may take several minutes...${NC}"
echo ""
read -p "Continue with tests? (y/N) or press Ctrl+C to cancel: " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}‚è≠Ô∏è  Tests skipped. Use 'git push --no-verify' to skip this hook.${NC}"
    exit 0
fi

echo ""
echo "üß™ Step 1/3: Running unit tests (mvn test with LocalStack)..."
echo "----------------------------------------------"
if ./run-tests-with-localstack.sh test; then
    echo -e "${GREEN}‚úÖ Unit tests passed${NC}"
else
    echo -e "${RED}‚ùå Unit tests failed. Fix errors before pushing.${NC}"
    exit 1
fi

echo ""
echo "üî® Step 2/3: Building and installing (mvn install with LocalStack)..."
echo "----------------------------------------------"
if ./run-tests-with-localstack.sh install; then
    echo -e "${GREEN}‚úÖ Build and install successful${NC}"
else
    echo -e "${RED}‚ùå Build failed. Fix errors before pushing.${NC}"
    exit 1
fi

echo ""
echo "üîç Step 3/3: Running integration tests (mvn verify with LocalStack)..."
echo "----------------------------------------------"
echo -e "${YELLOW}‚ö†Ô∏è  Note: This requires LocalStack/Docker to be running${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  The script will start LocalStack if needed${NC}"
echo ""
read -p "Continue with integration tests? (y/N): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if ./run-tests-with-localstack.sh verify; then
        echo -e "${GREEN}‚úÖ Integration tests passed${NC}"
    else
        echo -e "${RED}‚ùå Integration tests failed.${NC}"
        echo -e "${YELLOW}üí° Tip: Check LocalStack logs if needed${NC}"
        echo -e "${YELLOW}üí° Or skip with: git push --no-verify${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}‚è≠Ô∏è  Integration tests skipped${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ All tests passed! Proceeding with push...${NC}"
echo ""

exit 0

