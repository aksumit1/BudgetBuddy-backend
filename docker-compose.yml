networks:
  budgetbuddy-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
    # Configure DNS for external hostname resolution
    # Docker's embedded DNS (127.0.0.11) handles service discovery
    # External DNS servers handle external hostnames like sandbox.plaid.com
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.driver.mtu: "1500"

services:
  # LocalStack for local DynamoDB development
  localstack:
    image: localstack/localstack:latest
    container_name: budgetbuddy-localstack
    networks:
      - budgetbuddy-network
    ports:
      - "4566:4566"  # Fixed port - do not change
    # Auto-restart on failure (unless explicitly stopped)
    restart: unless-stopped
    environment:
      - SERVICES=dynamodb,s3,secretsmanager,cloudwatch,iam,sts,appconfig
      - DEBUG=0
      - PERSISTENCE=1
      # Pass through secrets from .env file for init script
      - JWT_SECRET=${JWT_SECRET:-test-secret-change-in-production-this-must-be-at-least-64-characters-long-for-hs512-algorithm-to-work-properly}
      - PLAID_CLIENT_ID=${PLAID_CLIENT_ID:-}
      - PLAID_SECRET=${PLAID_SECRET:-}
      - PLAID_ENVIRONMENT=${PLAID_ENVIRONMENT:-sandbox}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-sk_test_placeholder}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-}
      # Remove DOCKER_HOST - LocalStack will use the mounted socket directly
      # DOCKER_HOST was causing API version mismatch (v1.51 not supported)
      # The socket is mounted at /var/run/docker.sock, no need for DOCKER_HOST env var
    volumes:
      - localstack_data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts/init-localstack-secrets.sh:/etc/localstack/init/ready.d/init-secrets.sh:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: budgetbuddy-redis
    networks:
      - budgetbuddy-network
    ports:
      - "6379:6379"  # Local development stack uses port 6379
    # Auto-restart on failure (unless explicitly stopped)
    restart: unless-stopped
    # Optimize Redis for fast connections
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Separate Redis instance for tests - isolated from local development stack
  redis-test:
    image: redis:7-alpine
    container_name: budgetbuddy-redis-test
    networks:
      - budgetbuddy-network
    ports:
      - "6380:6379"  # Tests use port 6380 to avoid conflicts with local stack
    # Do NOT auto-restart - tests manage this container lifecycle
    restart: "no"
    # Optimize Redis for fast connections (same as main Redis)
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  backend:
    build:
      context: .
      dockerfile: Dockerfile.local
      platforms:
        - linux/arm64
    container_name: budgetbuddy-backend
    networks:
      - budgetbuddy-network
    ports:
      - "8080:8080"  # Fixed port - do not change
    # Auto-restart on failure (unless explicitly stopped)
    restart: unless-stopped
    environment:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      # LocalStack endpoints for all AWS services (matches production architecture)
      DYNAMODB_ENDPOINT: http://localstack:4566
      AWS_S3_ENDPOINT: http://localstack:4566
      AWS_SECRETS_MANAGER_ENDPOINT: http://localstack:4566
      AWS_APPCONFIG_ENDPOINT: http://localstack:4566
      AWS_CLOUDWATCH_ENDPOINT: http://localstack:4566
      AWS_S3_BUCKET: budgetbuddy-storage
      JWT_SECRET: test-secret-change-in-production-this-must-be-at-least-64-characters-long-for-hs512-algorithm-to-work-properly
      # Plaid credentials - use environment variables or .env file (NEVER commit real credentials)
      # For local development, create a .env file with:
      # PLAID_CLIENT_ID=your-client-id
      # PLAID_SECRET=your-secret
      PLAID_CLIENT_ID: ${PLAID_CLIENT_ID:-}
      PLAID_SECRET: ${PLAID_SECRET:-}
      PLAID_ENVIRONMENT: ${PLAID_ENVIRONMENT:-sandbox}
      PLAID_REDIRECT_URI: ${PLAID_REDIRECT_URI:-https://app.budgetbuddy.com/plaid/callback}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_placeholder}
      # Use service name for DNS resolution (Docker Compose handles this efficiently)
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      # Spring Profile
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-local}  # Set profile: local, dev, staging, prod
      # Enable production features to match production stack
      APP_CONFIG_ENABLED: ${APP_CONFIG_ENABLED:-true}  # Enabled to match production
      AWS_SECRETS_MANAGER_ENABLED: ${AWS_SECRETS_MANAGER_ENABLED:-true}  # Enabled to match production
      AWS_CLOUDWATCH_ENABLED: ${AWS_CLOUDWATCH_ENABLED:-true}  # Enabled to match production
      CACHE_WARMING_ENABLED: ${CACHE_WARMING_ENABLED:-true}  # Enabled to match production
      SERVER_SSL_ENABLED: ${SERVER_SSL_ENABLED:-false}  # Keep disabled for local (no SSL certs)
      MANAGEMENT_TRACING_ENABLED: ${MANAGEMENT_TRACING_ENABLED:-false}  # Keep disabled for local (reduces overhead)
      APPLE_TEAM_ID: ${APPLE_TEAM_ID:-TEAM_ID}
      APPLE_BUNDLE_ID: ${APPLE_BUNDLE_ID:-com.budgetbuddy.app}
      # MFA Configuration
      MFA_TOTP_ISSUER: ${MFA_TOTP_ISSUER:-BudgetBuddy (Local)}
      MFA_BACKUP_CODES_COUNT: ${MFA_BACKUP_CODES_COUNT:-10}
      MFA_BACKUP_CODES_LENGTH: ${MFA_BACKUP_CODES_LENGTH:-8}
      MFA_OTP_EXPIRATION_SECONDS: ${MFA_OTP_EXPIRATION_SECONDS:-300}
      # FIDO2 Configuration
      FIDO2_RP_ID: ${FIDO2_RP_ID:-localhost}
      FIDO2_RP_NAME: ${FIDO2_RP_NAME:-BudgetBuddy (Local)}
      FIDO2_ORIGIN: ${FIDO2_ORIGIN:-http://localhost:8080}
      FIDO2_CHALLENGE_EXPIRATION_SECONDS: ${FIDO2_CHALLENGE_EXPIRATION_SECONDS:-300}
      # Device Attestation Configuration
      DEVICE_ATTESTATION_ENABLED: ${DEVICE_ATTESTATION_ENABLED:-true}
      DEVICE_ATTESTATION_DEVICECHECK_ENABLED: ${DEVICE_ATTESTATION_DEVICECHECK_ENABLED:-true}
      DEVICE_ATTESTATION_PLAY_INTEGRITY_ENABLED: ${DEVICE_ATTESTATION_PLAY_INTEGRITY_ENABLED:-true}
      DEVICE_ATTESTATION_TRUST_WINDOW_HOURS: ${DEVICE_ATTESTATION_TRUST_WINDOW_HOURS:-24}
      # Behavioral Analysis Configuration
      BEHAVIORAL_ANALYSIS_ENABLED: ${BEHAVIORAL_ANALYSIS_ENABLED:-true}
      BEHAVIORAL_ANALYSIS_HISTORY_SIZE: ${BEHAVIORAL_ANALYSIS_HISTORY_SIZE:-100}
      BEHAVIORAL_ANALYSIS_WINDOW_SECONDS: ${BEHAVIORAL_ANALYSIS_WINDOW_SECONDS:-3600}
      BEHAVIORAL_ANALYSIS_HIGH_RISK_THRESHOLD: ${BEHAVIORAL_ANALYSIS_HIGH_RISK_THRESHOLD:-70.0}
      BEHAVIORAL_ANALYSIS_MEDIUM_RISK_THRESHOLD: ${BEHAVIORAL_ANALYSIS_MEDIUM_RISK_THRESHOLD:-40.0}
      # Optimize DNS resolution
      # Docker's embedded DNS must be FIRST for service discovery (redis, localstack)
      # External DNS servers are used as fallback for external hostnames (like sandbox.plaid.com)
    dns:
      - 127.0.0.11  # Docker's embedded DNS (MUST be first for service discovery within Docker network)
      - 8.8.8.8     # Google DNS (fallback for external hostnames)
      - 8.8.4.4     # Google DNS secondary (fallback)
    depends_on:
      localstack:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  localstack_data:
  redis_data:  # Local development Redis data
  redis_test_data:  # Test Redis data (isolated from local development)
