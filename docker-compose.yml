services:
  # LocalStack for local DynamoDB development
  localstack:
    image: localstack/localstack:latest
    container_name: budgetbuddy-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=dynamodb,s3,secretsmanager,cloudwatch,iam,sts
      - DEBUG=0
      - PERSISTENCE=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - localstack_data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: budgetbuddy-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  backend:
    build:
      context: .
      dockerfile: Dockerfile.local
      platforms:
        - linux/arm64
    container_name: budgetbuddy-backend
    ports:
      - "8080:8080"
    environment:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      DYNAMODB_ENDPOINT: http://localstack:4566
      AWS_S3_BUCKET: budgetbuddy-storage
      JWT_SECRET: test-secret-change-in-production-this-must-be-at-least-64-characters-long-for-hs512-algorithm-to-work-properly
      PLAID_CLIENT_ID: 69262b89a1808400220732ed
      PLAID_SECRET: 1fd73c16bc49a1a0f81c86c67127d3
      PLAID_ENVIRONMENT: sandbox
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_placeholder}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      APP_CONFIG_ENABLED: ${APP_CONFIG_ENABLED:-false}
      SERVER_SSL_ENABLED: ${SERVER_SSL_ENABLED:-false}
      MANAGEMENT_TRACING_ENABLED: 'false'
    depends_on:
      localstack:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  localstack_data:
  redis_data:
